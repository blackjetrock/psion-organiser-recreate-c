#include <ctype.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "psion_recreate_all.h"

#include "serial.h"

void Set_Column_Address(unsigned char add);
void Stop(void);
void Start(void);
void Set_Page_Address(unsigned char add);
void SentByte(unsigned char Byte);

#define Write_Address 0x78    /*slave addresses with write*/
#define Read_Address 0x79     /*slave addresses with read*/

int curx = 0;
int cury = 0;

// The font that we use for the character display
// basic 5x7 font
//
// Column order to match OLED RAM layout
unsigned char font_5x7_letters[] =
  {
   0x7F, 0x7F, 0x7F, 0x7F, 0x7F,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x5F, 0x00, 0x00,// !
   0x00, 0x07, 0x00, 0x07, 0x00,// "
   0x14, 0x7F, 0x14, 0x7F, 0x14,// 
   0x24, 0x2A, 0x7F, 0x2A, 0x12,// $
   0x23, 0x13, 0x08, 0x64, 0x62,// %
   0x36, 0x49, 0x55, 0x22, 0x50,// &
   0x00, 0x05, 0x03, 0x00, 0x00,// '
   0x00, 0x1C, 0x22, 0x41, 0x00,// (
   0x00, 0x41, 0x22, 0x1C, 0x00,// )
   0x08, 0x2A, 0x1C, 0x2A, 0x08,// *
   0x08, 0x08, 0x3E, 0x08, 0x08,// +
   0x00, 0x50, 0x30, 0x00, 0x00,// ,
   0x08, 0x08, 0x08, 0x08, 0x08,// -
   0x00, 0x60, 0x60, 0x00, 0x00,// .
   0x20, 0x10, 0x08, 0x04, 0x02,// 
   0x3E, 0x51, 0x49, 0x45, 0x3E,// 0       30
   0x00, 0x42, 0x7F, 0x40, 0x00,// 1
   0x42, 0x61, 0x51, 0x49, 0x46,// 2
   0x21, 0x41, 0x45, 0x4B, 0x31,// 3
   0x18, 0x14, 0x12, 0x7F, 0x10,// 4
   0x27, 0x45, 0x45, 0x45, 0x39,// 5
   0x3C, 0x4A, 0x49, 0x49, 0x30,// 6
   0x01, 0x71, 0x09, 0x05, 0x03,// 7
   0x36, 0x49, 0x49, 0x49, 0x36,// 8
   0x06, 0x49, 0x49, 0x29, 0x1E,// 9
   0x00, 0x36, 0x36, 0x00, 0x00,// :
   0x00, 0x56, 0x36, 0x00, 0x00,// ;
   0x00, 0x08, 0x14, 0x22, 0x41,// <
   0x14, 0x14, 0x14, 0x14, 0x14,// =
   0x41, 0x22, 0x14, 0x08, 0x00,// >
   0x02, 0x01, 0x51, 0x09, 0x06,// ?
   0x32, 0x49, 0x79, 0x41, 0x3E,// @
   0x7E, 0x11, 0x11, 0x11, 0x7E,// A         41
   0x7F, 0x49, 0x49, 0x49, 0x36,// B
   0x3E, 0x41, 0x41, 0x41, 0x22,// C
   0x7F, 0x41, 0x41, 0x22, 0x1C,// D
   0x7F, 0x49, 0x49, 0x49, 0x41,// E
   0x7F, 0x09, 0x09, 0x01, 0x01,// F
   0x3E, 0x41, 0x41, 0x51, 0x32,// G
   0x7F, 0x08, 0x08, 0x08, 0x7F,// H
   0x00, 0x41, 0x7F, 0x41, 0x00,// I
   0x20, 0x40, 0x41, 0x3F, 0x01,// J
   0x7F, 0x08, 0x14, 0x22, 0x41,// K
   0x7F, 0x40, 0x40, 0x40, 0x40,// L
   0x7F, 0x02, 0x04, 0x02, 0x7F,// M
   0x7F, 0x04, 0x08, 0x10, 0x7F,// N
   0x3E, 0x41, 0x41, 0x41, 0x3E,// O
   0x7F, 0x09, 0x09, 0x09, 0x06,// P
   0x3E, 0x41, 0x51, 0x21, 0x5E,// Q
   0x7F, 0x09, 0x19, 0x29, 0x46,// R
   0x46, 0x49, 0x49, 0x49, 0x31,// S
   0x01, 0x01, 0x7F, 0x01, 0x01,// T
   0x3F, 0x40, 0x40, 0x40, 0x3F,// U
   0x1F, 0x20, 0x40, 0x20, 0x1F,// V
   0x7F, 0x20, 0x18, 0x20, 0x7F,// W
   0x63, 0x14, 0x08, 0x14, 0x63,// X
   0x03, 0x04, 0x78, 0x04, 0x03,// Y
   0x61, 0x51, 0x49, 0x45, 0x43,// Z
   0x00, 0x00, 0x7F, 0x41, 0x41,// [
   0x02, 0x04, 0x08, 0x10, 0x20,// 
   0x41, 0x41, 0x7F, 0x00, 0x00,// 
   0x04, 0x02, 0x01, 0x02, 0x04,// ^
   0x40, 0x40, 0x40, 0x40, 0x40,// _
   0x00, 0x01, 0x02, 0x04, 0x00,// `
   0x20, 0x54, 0x54, 0x54, 0x78,// a          61
   0x7F, 0x48, 0x44, 0x44, 0x38,// b
   0x38, 0x44, 0x44, 0x44, 0x20,// c
   0x38, 0x44, 0x44, 0x48, 0x7F,// d
   0x38, 0x54, 0x54, 0x54, 0x18,// e
   0x08, 0x7E, 0x09, 0x01, 0x02,// f
   0x08, 0x14, 0x54, 0x54, 0x3C,// g
   0x7F, 0x08, 0x04, 0x04, 0x78,// h
   0x00, 0x44, 0x7D, 0x40, 0x00,// i
   0x20, 0x40, 0x44, 0x3D, 0x00,// j
   0x00, 0x7F, 0x10, 0x28, 0x44,// k
   0x00, 0x41, 0x7F, 0x40, 0x00,// l
   0x7C, 0x04, 0x18, 0x04, 0x78,// m
   0x7C, 0x08, 0x04, 0x04, 0x78,// n
   0x38, 0x44, 0x44, 0x44, 0x38,// o
   0x7C, 0x14, 0x14, 0x14, 0x08,// p
   0x08, 0x14, 0x14, 0x18, 0x7C,// q
   0x7C, 0x08, 0x04, 0x04, 0x08,// r
   0x48, 0x54, 0x54, 0x54, 0x20,// s
   0x04, 0x3F, 0x44, 0x40, 0x20,// t
   0x3C, 0x40, 0x40, 0x20, 0x7C,// u
   0x1C, 0x20, 0x40, 0x20, 0x1C,// v
   0x3C, 0x40, 0x30, 0x40, 0x3C,// w
   0x44, 0x28, 0x10, 0x28, 0x44,// x
   0x0C, 0x50, 0x50, 0x50, 0x3C,// y
   0x44, 0x64, 0x54, 0x4C, 0x44,// z
   0x00, 0x08, 0x36, 0x41, 0x00,// 
   0x00, 0x00, 0x7F, 0x00, 0x00,// |
   0x00, 0x41, 0x36, 0x08, 0x00,// 
   0x08, 0x08, 0x2A, 0x1C, 0x08,// ->
   0x08, 0x1C, 0x2A, 0x08, 0x08, // <-
   0x7F, 0x7F, 0x7F, 0x7F, 0x7F,// (space)  80
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)  81
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)  82    128d
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x30, 0x48, 0xc8, 0x48, 0x20,// (space) 135 
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)
   0x00, 0x00, 0x00, 0x00, 0x00,// (space)     A0
   0x00, 0x00, 0x5F, 0x00, 0x00,// !
   0x00, 0x07, 0x00, 0x07, 0x00,// "
   0x14, 0x7F, 0x14, 0x7F, 0x14,// 
   0x24, 0x2A, 0x7F, 0x2A, 0x12,// $
   0x23, 0x13, 0x08, 0x64, 0x62,// %
   0x36, 0x49, 0x55, 0x22, 0x50,// &
   0x00, 0x05, 0x03, 0x00, 0x00,// '
   0x00, 0x1C, 0x22, 0x41, 0x00,// (
   0x00, 0x41, 0x22, 0x1C, 0x00,// )
   0x08, 0x2A, 0x1C, 0x2A, 0x08,// *
   0x08, 0x08, 0x3E, 0x08, 0x08,// +
   0x00, 0x50, 0x30, 0x00, 0x00,// ,
   0x08, 0x08, 0x08, 0x08, 0x08,// -
   0x00, 0x60, 0x60, 0x00, 0x00,// .
   0x20, 0x10, 0x08, 0x04, 0x02,// 
   0x3E, 0x51, 0x49, 0x45, 0x3E,// 0
   0x00, 0x42, 0x7F, 0x40, 0x00,// 1
   0x42, 0x61, 0x51, 0x49, 0x46,// 2
   0x21, 0x41, 0x45, 0x4B, 0x31,// 3
   0x18, 0x14, 0x12, 0x7F, 0x10,// 4
   0x27, 0x45, 0x45, 0x45, 0x39,// 5
   0x3C, 0x4A, 0x49, 0x49, 0x30,// 6
   0x01, 0x71, 0x09, 0x05, 0x03,// 7
   0x36, 0x49, 0x49, 0x49, 0x36,// 8
   0x06, 0x49, 0x49, 0x29, 0x1E,// 9
   0x00, 0x36, 0x36, 0x00, 0x00,// :
   0x00, 0x56, 0x36, 0x00, 0x00,// ;
   0x00, 0x08, 0x14, 0x22, 0x41,// <
   0x14, 0x14, 0x14, 0x14, 0x14,// =
   0x41, 0x22, 0x14, 0x08, 0x00,// >
   0x02, 0x01, 0x51, 0x09, 0x06,// ?
   0x32, 0x49, 0x79, 0x41, 0x3E,// @             C0
   0x7E, 0x11, 0x11, 0x11, 0x7E,// A
   0x7F, 0x49, 0x49, 0x49, 0x36,// B
   0x3E, 0x41, 0x41, 0x41, 0x22,// C
   0x7F, 0x41, 0x41, 0x22, 0x1C,// D
   0x7F, 0x49, 0x49, 0x49, 0x41,// E
   0x7F, 0x09, 0x09, 0x01, 0x01,// F
   0x3E, 0x41, 0x41, 0x51, 0x32,// G
   0x7F, 0x08, 0x08, 0x08, 0x7F,// H
   0x00, 0x41, 0x7F, 0x41, 0x00,// I
   0x20, 0x40, 0x41, 0x3F, 0x01,// J
   0x7F, 0x08, 0x14, 0x22, 0x41,// K
   0x7F, 0x40, 0x40, 0x40, 0x40,// L
   0x7F, 0x02, 0x04, 0x02, 0x7F,// M
   0x7F, 0x04, 0x08, 0x10, 0x7F,// N
   0x3E, 0x41, 0x41, 0x41, 0x3E,// O
   0x7F, 0x09, 0x09, 0x09, 0x06,// P
   0x3E, 0x41, 0x51, 0x21, 0x5E,// Q
   0x7F, 0x09, 0x19, 0x29, 0x46,// R
   0x46, 0x49, 0x49, 0x49, 0x31,// S
   0x01, 0x01, 0x7F, 0x01, 0x01,// T
   0x3F, 0x40, 0x40, 0x40, 0x3F,// U
   0x1F, 0x20, 0x40, 0x20, 0x1F,// V
   0x7F, 0x20, 0x18, 0x20, 0x7F,// W
   0x63, 0x14, 0x08, 0x14, 0x63,// X
   0x03, 0x04, 0x78, 0x04, 0x03,// Y
   0x61, 0x51, 0x49, 0x45, 0x43,// Z
   0x00, 0x00, 0x7F, 0x41, 0x41,// [
   0x02, 0x04, 0x08, 0x10, 0x20,// 
   0x41, 0x41, 0x7F, 0x00, 0x00,// 
   0x04, 0x02, 0x01, 0x02, 0x04,// ^
   0x40, 0x40, 0x40, 0x40, 0x40,// _
   0x00, 0x01, 0x02, 0x04, 0x00,// `      E0
   0x20, 0x54, 0x54, 0x54, 0x78,// a
   0x7F, 0x48, 0x44, 0x44, 0x38,// b
   0x38, 0x44, 0x44, 0x44, 0x20,// c
   0x38, 0x44, 0x44, 0x48, 0x7F,// d
   0x38, 0x54, 0x54, 0x54, 0x18,// e
   0x08, 0x7E, 0x09, 0x01, 0x02,// f
   0x08, 0x14, 0x54, 0x54, 0x3C,// g
   0x7F, 0x08, 0x04, 0x04, 0x78,// h
   0x00, 0x44, 0x7D, 0x40, 0x00,// i
   0x20, 0x40, 0x44, 0x3D, 0x00,// j
   0x00, 0x7F, 0x10, 0x28, 0x44,// k
   0x00, 0x41, 0x7F, 0x40, 0x00,// l
   0x7C, 0x04, 0x18, 0x04, 0x78,// m
   0x7C, 0x08, 0x04, 0x04, 0x78,// n
   0x38, 0x44, 0x44, 0x44, 0x38,// o
   0x7C, 0x14, 0x14, 0x14, 0x08,// p       F0
   0x08, 0x14, 0x14, 0x18, 0x7C,// q
   0x7C, 0x08, 0x04, 0x04, 0x08,// r
   0x48, 0x54, 0x54, 0x54, 0x20,// s
   0x04, 0x3F, 0x44, 0x40, 0x20,// t
   0x3C, 0x40, 0x40, 0x20, 0x7C,// u
   0x1C, 0x20, 0x40, 0x20, 0x1C,// v
   0x3C, 0x40, 0x30, 0x40, 0x3C,// w
   0x44, 0x28, 0x10, 0x28, 0x44,// x
   0x0C, 0x50, 0x50, 0x50, 0x3C,// y
   0x44, 0x64, 0x54, 0x4C, 0x44,// z
   0x00, 0x08, 0x36, 0x41, 0x00,// 
   0x00, 0x00, 0x7F, 0x00, 0x00,// |
   0x00, 0x41, 0x36, 0x08, 0x00,// 
   0x08, 0x08, 0x2A, 0x1C, 0x08,// ->
   0x08, 0x1C, 0x2A, 0x08, 0x08, // <-
   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, //  Blinking block Cursor character     100     256d
   0x7F, 0x7F, 0x7F, 0x7F, 0x7F, //  character that is a copied underlined char
   
  };


////////////////////////////////////////////////////////////////////////////////
//
//

int invert_byte(int b)
{
  int r = 0;

  for(int i=0; i<8; i++)
    {
      r <<= 1;
      r |=(b & 1);
      b >>= 1;
    }
  return(r);
}

////////////////////////////////////////////////////////////////////////////////
//
// Prints a character at (X,Y)
//
// ** internal functions that only dump_lcd should use
//
////////////////////////////////////////////////////////////////////////////////

// Where the last character was printed, plus one character, i.e.
// where a 'flowed' character will be displayed next

int printpos_x = 0;
int printpos_y = 0;
int printpos_at_end = 0;

void next_printpos_line(void)
{
#if DB_NEXT_PRINTPOS
  printf("\n%s:Entry printpos_at_end:%d printpos_x:%d printpos_y:%d", __FUNCTION__, printpos_at_end, printpos_x, printpos_y);
#endif
  
  printpos_x = 0;
  printpos_y++;
  
  if( printpos_y >= DISPLAY_NUM_LINES )
    {
      printpos_y--;
      printpos_x = (DISPLAY_NUM_CHARS-2);
    }
  
  if( (printpos_x == (DISPLAY_NUM_CHARS-2)) && (printpos_y == (DISPLAY_NUM_LINES-1) ))
    {
      printpos_at_end = 1;
    }
  else
    {
      printpos_at_end = 0;
    }

#if DB_NEXT_PRINTPOS
  printf("\n%s:Exit printpos_at_end:%d printpos_x:%d printpos_y:%d", __FUNCTION__, printpos_at_end, printpos_x, printpos_y);
#endif

}

// Move to next position for printing
void next_printpos(int ch)
{
  printpos_x++;
  
  if( (printpos_x >= DISPLAY_NUM_CHARS) || (ch == KEY_TAB)  )
    {
      next_printpos_line();
    }
  
  if( (printpos_x == (DISPLAY_NUM_CHARS-2)) && (printpos_y == (DISPLAY_NUM_LINES-1) ))
    {
      printpos_at_end = 1;
    }
  else
    {
      printpos_at_end = 0;
    }
  
}

void new_line(void)
{

}


void i2c_ssd_plot_point(int x, int y, int mode)
{
  int cx, cy;
  
  if( (x < 0) || (x>127)  )
    {
      return;
    }

  if( (y < 0) || (y>31)  )
    {
      return;
    }
  
  //printf("\nX:%d Y:%d", x, y);
  
  cx = 127-x;
  cy = 3-y/8;

  //printf("  cx:%d cy:%d", cx, cy);
  
  Set_Page_Address(cy);
  Set_Column_Address(cx+4);

  i2c_start(I2C_BUS_OLED);
  
  // Send slave address with read bit
  i2c_send_byte(I2C_BUS_OLED, Write_Address);
  i2c_send_byte(I2C_BUS_OLED, 0x40);

  // Set a pixel
  //  i2c_send_byte(0x1 << (y % 8));

  uint8_t byte = display_pixels[cy*128+cx];


  //printf("  IDX:%d", cy*128+cx);
  //printf("  byte:%02X", byte);

  switch(mode)
    {
    case 1:
      byte |= (0x1 << (y % 8));
      break;

    case 0:
      byte &= ~(1 << (y % 8));
      break;
    }
  //printf("  byte:%02X", byte);

  serial_plot_point_byte(x, y, mode);
  
  i2c_send_byte(I2C_BUS_OLED, invert_byte(byte));

  display_pixels[cy*128+cx] = byte;
  //printf("  byte:%02X", byte);
  
  //  i2c_send_byte(0);
  i2c_stop(I2C_BUS_OLED);
}

//------------------------------------------------------------------------------

void i_printxy(int x, int y, int ch)
{
  int cx, cy;

  // Set the character that the cursor is on top of
  if( (x == cursor_x) && (y == cursor_y),1 )
    {
      under_cursor_char[x][y] = ch;
    }

  // Update the current print position
  printpos_x = x;
  printpos_y = y;
  next_printpos(ch);

  serial_display_xy(x, y, ch);
  
  ch -= 0;
  
  cx = 127-(x * 6);
  cy = 3-y;

#if DD
  dd_char_at_xy(x, y, ch);
  dd_update();
#else
  
#if SPI
  SSD1309_char(x*6, y, ch, 12, 1);
  SSD1309_display();
#else
  Set_Page_Address(cy);
  Set_Column_Address(cx);
  
  i2c_start(I2C_BUS_OLED);
  
  // Send slave address with read bit
  i2c_send_byte(I2C_BUS_OLED, Write_Address);
  i2c_send_byte(I2C_BUS_OLED, 0x40);
  
  for(int j=0; j<5; j++)
    {
      i2c_send_byte(I2C_BUS_OLED, invert_byte(font_5x7_letters[ch*5+(4-j)]));
    }
  i2c_send_byte(I2C_BUS_OLED, 0);
  i2c_stop(I2C_BUS_OLED);
#endif
#endif
  
}

void i2c_ssd(int cx, int cy, int ch)
{
  Set_Page_Address(cy);
  Set_Column_Address(cx);
  
  i2c_start(I2C_BUS_OLED);
  
  // Send slave address with read bit
  i2c_send_byte(I2C_BUS_OLED, Write_Address);
  i2c_send_byte(I2C_BUS_OLED, 0x40);
  
  for(int j=0; j<5; j++)
    {
      i2c_send_byte(I2C_BUS_OLED, invert_byte(font_5x7_letters[ch*5+(4-j)]));
    }
  i2c_send_byte(I2C_BUS_OLED, 0);
  i2c_stop(I2C_BUS_OLED);
}

void i2c_ssd_clear_oled(void)
{
  unsigned char i,j,num = 0;
  
  for(i=0; i<0x04; i++)
    {
      Set_Page_Address(i);
      Set_Column_Address(0x00);

#if NEW_I2C
      i2c_start(I2C_BUS_OLED);
      i2c_send_byte(I2C_BUS_OLED, Write_Address);
      i2c_send_byte(I2C_BUS_OLED, 0x40);

      for(j=0; j<132; j++)
	{
	  i2c_send_byte(I2C_BUS_OLED, 0);
	}
      
      i2c_stop(I2C_BUS_OLED);
#else
      Start();
      SentByte(I2C_BUS_OLED, Write_Address);
      SentByte(I2C_BUS_OLED, 0x40);
      
      for(j=0; j<132; j++)
	{
	  SentByte(0);
	}
      Stop();
#endif
    }
}

void print_cursor(int x, int y, int ch)
{
  int cx, cy;

#if 0
  serial_display_xy(x, y, ch);
  
  ch -= 0;
  
  cx = 127-(x * 6);
  cy = 3-y;

  i_printxy(x, y, ch);
  return;
  
  Set_Page_Address(cy);
  Set_Column_Address(cx);

  i2c_start(I2C_BUS_OLED);
  
  // Send slave address with read bit
  i2c_send_byte(I2C_BUS_OLED, Write_Address);
  i2c_send_byte(I2C_BUS_OLED, 0x40);

  for(int j=0; j<5; j++)
    {
      i2c_send_byte(I2C_BUS_OLED, invert_byte(font_5x7_letters[ch*5+(4-j)]));
    }
  i2c_send_byte(I2C_BUS_OLED, 0);
  i2c_stop(I2C_BUS_OLED);
#else
  dd_char_at_xy(x, y, ch);
  dd_update();
#endif
}

////////////////////////////////////////////////////////////////////////////////
//
// Prints a string at (X,Y)
//

void i_printxy_str(int x, int y, char *str)
{
  curx = x;
  cury = y;
  
  //printf("\ncurx:%d, cury:%d str:'%s'", curx, cury, str);
  
  while(*str)
    {
      i_printxy(curx++, cury, *(str++));
      //      curx += strlen(s);
      
      if( curx >= DISPLAY_NUM_CHARS )
	{
	  print_nl();
	}
    }
}

////////////////////////////////////////////////////////////////////////////////
//
// Prints a value in hex as (X,Y)
//

void i_printxy_hex(int x, int y, int value)
{
  char hs[10];

  sprintf(hs, "%02X", value);
  i_printxy_str(x, y, hs);
}

////////////////////////////////////////////////////////////////////////////////
//
// 'External' functions that the rest of the code uses
//

void printxy(int x, int y, int ch)
{
  i_printxy(x, y, ch);
  //  put_display_char(x, y, ch);
}

////////////////////////////////////////////////////////////////////////////////
//
// Prints a string at (X,Y)
//

void printxy_str(int x, int y, char *str)
{
#if 0
  while(*str)
    {
      printxy(x++, y, *(str++));
    }
#else
  i_printxy_str(x, y, str);
#endif
}

////////////////////////////////////////////////////////////////////////////////
//
// Prints a value in hex as (X,Y)
//

void printxy_hex(int x, int y, int value)
{
  char hs[10];

  sprintf(hs, "%02X", value);
  i_printxy_str(x, y, hs);
}


////////////////////////////////////////////////////////////////////////////////
//
//  Cursor positioned functions
//
////////////////////////////////////////////////////////////////////////////////


void print_home(void)
{
  curx = 0;
  cury = 0;
}

void print_nl(void)
{
  curx = 0;
  cury++;
  
  if( cury >= DISPLAY_NUM_LINES )
    {
      cury = 0;
    }
}

void print_str(char *s)
{
  i_printxy_str(curx, cury, s);

#if 0
  curx += strlen(s);

  if( curx >= DISPLAY_NUM_CHARS )
    {
      print_nl();
    }
#endif
}

void print_nl_if_necessary(char *str)
{
  if( (strlen(str) + curx) >= DISPLAY_NUM_CHARS )
    {
      print_nl();
    }
}
